# -----------------------------------------------------------------------------
# nginx reverse-proxy config for py-foswiki.performiq.com
#
# Web UI  → https://py-foswiki.performiq.com        → 127.0.0.1:8221
# API     → https://py-foswiki.performiq.com:8443   → 127.0.0.1:8621
#
# Assumes SSL certificates are already in place (e.g. via certbot/Let's Encrypt).
# Place this file in /etc/nginx/sites-available/ and symlink to sites-enabled/.
# -----------------------------------------------------------------------------

# ── Web UI (port 443 / HTTPS) ─────────────────────────────────────────────────

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name py-foswiki.performiq.com;

    ssl_certificate     /etc/letsencrypt/live/py-foswiki.performiq.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/py-foswiki.performiq.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header X-Frame-Options        "SAMEORIGIN"   always;
    add_header X-Content-Type-Options "nosniff"      always;
    add_header Referrer-Policy        "strict-origin" always;

    # Proxy to Web UI uvicorn
    location / {
        proxy_pass         http://127.0.0.1:8221;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;

        # Allow large file uploads (attachments)
        client_max_body_size 55M;
    }

    # Redirect bare HTTP → HTTPS
    error_page 497 https://$host$request_uri;
}

# ── API (port 8443 / HTTPS) ───────────────────────────────────────────────────

server {
    listen 8443 ssl http2;
    listen [::]:8443 ssl http2;
    server_name py-foswiki.performiq.com;

    ssl_certificate     /etc/letsencrypt/live/py-foswiki.performiq.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/py-foswiki.performiq.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # Security headers
    add_header X-Frame-Options        "SAMEORIGIN"   always;
    add_header X-Content-Type-Options "nosniff"      always;

    # Proxy to API uvicorn
    location / {
        proxy_pass         http://127.0.0.1:8621;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;

        # Allow large file uploads
        client_max_body_size 55M;
    }
}

# ── HTTP → HTTPS redirect ─────────────────────────────────────────────────────

server {
    listen 80;
    listen [::]:80;
    server_name py-foswiki.performiq.com;
    return 301 https://$host$request_uri;
}
